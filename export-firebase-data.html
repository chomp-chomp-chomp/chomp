<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Export Firebase Data to JSON</title>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #353535; margin-bottom: 10px; }
    .subtitle { color: #666; margin-bottom: 30px; }
    button {
      background: #e73b42;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 10px 10px 0;
    }
    button:hover { background: #d32f35; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .status {
      margin-top: 20px;
      padding: 15px;
      border-radius: 4px;
      background: #f0f0f0;
    }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .collection-status {
      margin: 10px 0;
      padding: 10px;
      background: #e9ecef;
      border-radius: 4px;
    }
    pre {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      max-height: 300px;
    }
    .download-link {
      display: inline-block;
      margin: 5px 10px 5px 0;
      padding: 8px 16px;
      background: #28a745;
      color: white;
      text-decoration: none;
      border-radius: 4px;
    }
    .download-link:hover { background: #218838; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ðŸ”„ Export Firebase Data to JSON</h1>
    <p class="subtitle">This tool will export all your Firestore data to JSON files for migration to Sveltia CMS.</p>

    <div>
      <button id="exportAllBtn">Export All Collections</button>
      <button id="exportRecipesBtn">Export Recipes Only</button>
      <button id="exportPostsBtn">Export Posts Only</button>
      <button id="exportLexiconBtn">Export Lexicon Only</button>
      <button id="exportReadingListBtn">Export Reading List Only</button>
      <button id="exportPlaylistsBtn">Export Playlists Only</button>
    </div>

    <div id="status"></div>
    <div id="downloads"></div>
    <div id="preview"></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDcQ-P41Ec71cjdTvN4khywjbvdz8fmD9I",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "496652168677",
      appId: "1:496652168677:web:20ca3a1b4f77adf2c0bc9f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const projectId = firebaseConfig.projectId;

    const statusDiv = document.getElementById('status');
    const downloadsDiv = document.getElementById('downloads');
    const previewDiv = document.getElementById('preview');

    const collections = {
      recipes: `artifacts/${projectId}/public/data/recipes`,
      posts: `artifacts/${projectId}/public/data/posts`,
      lexicon: `artifacts/${projectId}/public/data/lexicon`,
      'reading-list': `artifacts/${projectId}/public/data/reading-list`,
      playlists: `artifacts/${projectId}/public/data/playlists`
    };

    function showStatus(message, type = 'info') {
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = message;
    }

    function downloadJSON(data, filename) {
      const json = JSON.stringify(data, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportCollection(collectionName, collectionPath) {
      try {
        showStatus(`ðŸ“¥ Fetching ${collectionName}...`, 'info');

        const collectionRef = collection(db, collectionPath);
        const snapshot = await getDocs(collectionRef);

        const data = [];
        snapshot.forEach(doc => {
          const docData = doc.data();

          // Convert Firestore Timestamps to ISO strings
          Object.keys(docData).forEach(key => {
            if (docData[key] && typeof docData[key].toDate === 'function') {
              docData[key] = docData[key].toDate().toISOString();
            }
          });

          data.push({
            id: doc.id,
            ...docData
          });
        });

        showStatus(`âœ… Exported ${data.length} ${collectionName}!`, 'success');

        // Add download link
        const link = document.createElement('a');
        link.href = '#';
        link.className = 'download-link';
        link.textContent = `ðŸ“¥ Download ${collectionName}.json (${data.length} items)`;
        link.onclick = (e) => {
          e.preventDefault();
          downloadJSON(data, `${collectionName}.json`);
        };
        downloadsDiv.appendChild(link);
        downloadsDiv.appendChild(document.createElement('br'));

        // Show preview
        const preview = document.createElement('div');
        preview.innerHTML = `
          <h3>${collectionName}.json Preview (first 3 items):</h3>
          <pre>${JSON.stringify(data.slice(0, 3), null, 2)}</pre>
        `;
        previewDiv.appendChild(preview);

        return data;
      } catch (error) {
        showStatus(`âŒ Error exporting ${collectionName}: ${error.message}`, 'error');
        console.error(`Error exporting ${collectionName}:`, error);
        return null;
      }
    }

    async function exportAll() {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      showStatus('ðŸ”„ Starting export of all collections...', 'info');

      const exportedData = {};

      for (const [name, path] of Object.entries(collections)) {
        const data = await exportCollection(name, path);
        if (data) {
          exportedData[name] = data;
        }
      }

      // Create a combined download
      const link = document.createElement('a');
      link.href = '#';
      link.className = 'download-link';
      link.style.background = '#007bff';
      link.textContent = `ðŸ“¦ Download ALL Data (Combined JSON)`;
      link.onclick = (e) => {
        e.preventDefault();
        downloadJSON(exportedData, 'firebase-export-all.json');
      };
      downloadsDiv.insertBefore(link, downloadsDiv.firstChild);
      downloadsDiv.insertBefore(document.createElement('br'), downloadsDiv.childNodes[1]);

      showStatus(`âœ… Export complete! Downloaded ${Object.keys(exportedData).length} collections.`, 'success');
    }

    // Event Listeners
    document.getElementById('exportAllBtn').addEventListener('click', exportAll);
    document.getElementById('exportRecipesBtn').addEventListener('click', () => {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      exportCollection('recipes', collections.recipes);
    });
    document.getElementById('exportPostsBtn').addEventListener('click', () => {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      exportCollection('posts', collections.posts);
    });
    document.getElementById('exportLexiconBtn').addEventListener('click', () => {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      exportCollection('lexicon', collections.lexicon);
    });
    document.getElementById('exportReadingListBtn').addEventListener('click', () => {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      exportCollection('reading-list', collections['reading-list']);
    });
    document.getElementById('exportPlaylistsBtn').addEventListener('click', () => {
      downloadsDiv.innerHTML = '';
      previewDiv.innerHTML = '';
      exportCollection('playlists', collections.playlists);
    });

    // Auto-run export on load (comment out if you want manual control)
    setTimeout(() => {
      showStatus('Click "Export All Collections" to start the migration!', 'info');
    }, 500);
  </script>
</body>
</html>
