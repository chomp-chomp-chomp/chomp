<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chomp Chomp: Recipes & Rituals</title>

  <link rel="icon" type="image/jpeg" href="https://firebasestorage.googleapis.com/v0/b/chomp-chomp-recipes.firebasestorage.app/o/recipes%2Fchomp_recipes_logo.jpeg?alt=media">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="styles.css">

  <style>
    /* Styling for the Search and Filter area */
    .recipe-search-box {
      width: 100%;
      padding: 12px 16px;
      font-size: 15px;
      font-family: 'Inter', sans-serif;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: white;
      color: #333;
    }

    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 30px;
      align-items: center;
    }

    .filter-controls select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      height: 44px;
      background: white;
    }
    
    .filter-controls button {
        height: 44px;
        cursor: pointer;
    }

    /* Helper styles in case styles.css fails */
    .btn-primary { background-color: #333; color: white; border: none; padding: 0 20px; border-radius: 4px; }
    .btn-outline { background-color: transparent; border: 1px solid #333; color: #333; padding: 0 20px; border-radius: 4px; }
    .text-muted { color: #666; }
    .text-center { text-align: center; }
  </style>
</head>
<body>

  <header class="site-header">
    <nav class="site-nav">
      <div class="header-left">
        <a href="index.html" class="site-logo">
           <span style="font-weight: bold; font-size: 1.2em;">Chomp Chomp</span>
        </a>
      </div>
      <div class="header-right">
        <a href="index.html" style="margin-right: 15px; text-decoration: none; color: black;">Home</a>
        <a href="recipes.html" style="font-weight: bold; text-decoration: none; color: black;">Recipes</a>
      </div>
    </nav>
  </header>

  <main class="page-container" style="padding-top: 120px; min-height: 80vh; max-width: 1200px; margin: 0 auto; padding-left: 20px; padding-right: 20px;">

    <section class="content-wrapper text-center" style="margin-bottom: 40px;">
      <h1>Recipes & Rituals</h1>
      <p class="text-muted">Browse, search, and discover your next baking adventure</p>
      <hr style="width: 60px; margin: 20px auto; border: none; border-top: 1px solid #ccc;">
    </section>

    <section class="content-wrapper">
      <div class="filter-controls">
        
        <div style="display: flex; gap: 8px; flex: 1 1 300px; max-width: 500px;">
            <input type="text"
                   class="recipe-search-box"
                   id="recipeSearch"
                   placeholder="Search recipes..."
                   style="margin: 0; flex: 1;">
            
            <button id="searchBtn" class="btn btn-primary" style="white-space: nowrap;">
                Search
            </button>
        </div>

        <select id="categoryFilter">
          <option value="all">All Categories</option>
        </select>

        <select id="dishTypeFilter">
          <option value="all">All Dish Types</option>
        </select>

        <select id="sortBy">
          <option value="alphabetical">Sort: A-Z</option>
          <option value="newest">Sort: Newest</option>
          <option value="time">Sort: Quickest Time</option>
        </select>

        <button id="clearBtn" class="btn btn-outline">Clear Filters</button>
      </div>
    </section>

    <section class="recipe-grid" id="recipeGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px;">
      
      <div id="loadingMsg" style="grid-column: 1/-1; text-align: center; padding: 50px; color: #666;">
        <h3>Loading Recipes...</h3>
        <p>Connecting to Chomp Database</p>
      </div>

      <div class="no-results" id="noResults" style="display: none; grid-column: 1 / -1; text-align: center;">
        No recipes found. Try adjusting your filters.
      </div>

    </section>

    <div class="text-center" style="margin-top: 50px; margin-bottom: 50px;">
      <button class="btn btn-primary" id="loadMoreBtn" onclick="loadMoreRecipes()" style="display: none;">
        Load More Recipes
      </button>
    </div>

  </main>

  <footer class="site-footer" style="text-align: center; padding: 40px; border-top: 1px solid #eee; margin-top: auto;">
    <p>Baking is the materialization of comfort itself.</p>
    <p style="font-size: 0.85em; color: #888;">&copy; 2025 Chomp Chomp</p>
  </footer>

  <script type="module">
    // Using version 10.7.1 because your Debug Test proved it works
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCCPb87ZtJbpI7YRRwKVNL-g3O-VrONwtM",
      authDomain: "chomp-chomp-recipes.firebaseapp.com",
      projectId: "chomp-chomp-recipes",
      storageBucket: "chomp-chomp-recipes.firebasestorage.app",
      messagingSenderId: "225432495618",
      appId: "1:225432495618:web:459eb1c0b7228dfc24e91b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const appId = firebaseConfig.projectId;

    let recipes = [];
    let displayedRecipes = 0;
    const RECIPES_PER_PAGE = 15;

    // Helpers
    function generateSlug(title) {
      return title.toLowerCase().replace(/[^a-z0-9\s-]/g, '').replace(/\s+/g, '-').trim('-');
    }

    function parseTime(timeString) {
      if (!timeString) return Infinity;
      const rangeMatch = String(timeString).match(/^(\d+)/);
      const rangeMinutes = rangeMatch ? parseInt(rangeMatch[1]) : 0;
      const hoursMatch = String(timeString).match(/(\d+)\s*h/);
      const hours = hoursMatch ? parseInt(hoursMatch[1]) * 60 : 0;
      const minutesMatch = String(timeString).match(/(\d+)\s*min/);
      const minutes = minutesMatch ? parseInt(minutesMatch[1]) : 0;
      return (hours + minutes > 0) ? hours + minutes : (rangeMinutes > 0 ? rangeMinutes : Infinity);
    }

    function assignDishType(title) {
      const lower = title.toLowerCase();
      if (lower.includes('cake') || lower.includes('pie')) return 'Dessert/Pastry';
      if (lower.includes('cookie')) return 'Cookie/Bar';
      if (lower.includes('soup')) return 'Soup';
      return 'Other Baked Goods';
    }

    function isSafeJson(str) {
      if (typeof str !== 'string') return false;
      str = str.trim();
      return (str.startsWith('{') && str.endsWith('}')) || (str.startsWith('[') && str.endsWith(']'));
    }

    // --- MAIN LOGIC ---
    function setupRecipeListener() {
      // USING THE PATH THAT WORKED IN DEBUG TEST
      const recipesRef = collection(db, `artifacts/${appId}/public/data/recipes`);
      const q = query(recipesRef);

      onSnapshot(q, (snapshot) => {
        recipes = snapshot.docs.map(doc => {
          const data = doc.data();
          
          // Safety checks for ingredients/source JSON
          let parsedIngredients = [];
          if (typeof data.ingredients === 'string' && isSafeJson(data.ingredients)) {
             try { parsedIngredients = JSON.parse(data.ingredients); } catch(e) {}
          } else if (Array.isArray(data.ingredients)) {
             parsedIngredients = data.ingredients;
          }

          return {
            ...data,
            ingredients: parsedIngredients,
            slug: data.slug || generateSlug(data.title || "Untitled"),
            totalTimeInMinutes: parseTime(data.totalTime || data.cookTime),
            dishType: data.dishType || assignDishType(data.title || "")
          };
        });

        // Data Loaded -> Remove Loading Message
        const loadingMsg = document.getElementById('loadingMsg');
        if(loadingMsg) loadingMsg.style.display = 'none';

        populateFilters();
        applyFiltersAndDisplay();

      }, (error) => {
        console.error("Error loading recipes:", error);
        const loadingMsg = document.getElementById('loadingMsg');
        if(loadingMsg) {
            loadingMsg.innerHTML = "Error loading recipes. Check console.";
            loadingMsg.style.color = "red";
        }
      });
    }

    function populateFilters() {
      const categories = [...new Set(recipes.map(r => r.category).filter(c => c))].sort();
      const dishTypes = [...new Set(recipes.map(r => r.dishType).filter(d => d))].sort();

      const catSelect = document.getElementById('categoryFilter');
      catSelect.innerHTML = '<option value="all">All Categories</option>' + 
        categories.map(c => `<option value="${c}">${c}</option>`).join('');

      const dishSelect = document.getElementById('dishTypeFilter');
      dishSelect.innerHTML = '<option value="all">All Dish Types</option>' + 
        dishTypes.map(d => `<option value="${d}">${d}</option>`).join('');
    }

    function applyFiltersAndDisplay() {
      const searchTerm = document.getElementById('recipeSearch').value.toLowerCase();
      const category = document.getElementById('categoryFilter').value;
      const dishType = document.getElementById('dishTypeFilter').value;
      const sortBy = document.getElementById('sortBy').value;

      let filtered = recipes.filter(r => {
        const matchesSearch = !searchTerm || 
          (r.title && r.title.toLowerCase().includes(searchTerm)) ||
          (r.description && r.description.toLowerCase().includes(searchTerm));
        
        const matchesCategory = category === 'all' || r.category === category;
        const matchesDishType = dishType === 'all' || r.dishType === dishType;

        return matchesSearch && matchesCategory && matchesDishType;
      });

      if (sortBy === 'time') filtered.sort((a, b) => a.totalTimeInMinutes - b.totalTimeInMinutes);
      else if (sortBy === 'newest') filtered.reverse();
      else filtered.sort((a, b) => (a.title || "").localeCompare(b.title || ""));

      displayRecipes(filtered);
    }

    function displayRecipes(recipesToShow) {
      const grid = document.getElementById('recipeGrid');
      const noResults = document.getElementById('noResults');
      const loadMoreBtn = document.getElementById('loadMoreBtn');

      // Clear current grid (except loading/no-results divs, which we handle manually)
      // A cleaner way: rebuild string.
      if (recipesToShow.length === 0) {
        noResults.style.display = 'block';
        loadMoreBtn.style.display = 'none';
        // Clear grid cards but keep utility divs
        Array.from(grid.children).forEach(child => {
            if(child.id !== 'loadingMsg' && child.id !== 'noResults') child.remove();
        });
        return;
      }

      noResults.style.display = 'none';
      displayedRecipes = Math.min(RECIPES_PER_PAGE, recipesToShow.length);

      const cardsHtml = recipesToShow.slice(0, displayedRecipes).map(recipe => {
        const timeText = recipe.totalTimeInMinutes === Infinity ? 'Time N/A' : `${recipe.totalTimeInMinutes} min`;
        const imagePath = recipe.image
          ? (recipe.image.startsWith('http') ? recipe.image : `images/${recipe.image}`)
          : null;

        return `
          <article class="recipe-card" style="border:1px solid #eee; border-radius:8px; overflow:hidden; cursor:pointer;" onclick="window.location.href='recipe.html?slug=${recipe.slug}'">
            ${imagePath
              ? `<img src="${imagePath}" alt="${recipe.title}" style="width:100%; height:200px; object-fit:cover;">`
              : `<div style="width:100%; height:200px; background:#f5f5f5; display:flex; align-items:center; justify-content:center; color:#999;">No Image</div>`
            }
            <div style="padding:15px;">
              <h3 style="margin:0 0 10px 0; font-size:1.1em;">${recipe.title}</h3>
              <div style="display:flex; justify-content:space-between; font-size:0.85em; color:#666;">
                <span style="color:#e73b42;">${recipe.dishType}</span>
                <span>${timeText}</span>
              </div>
            </div>
          </article>
        `;
      }).join('');

      // We need to inject this HTML without deleting the hidden loading/noResult divs
      // Simplest way: Set innerHTML but add back the hidden divs? 
      // Or just overwrite everything since loading is done.
      grid.innerHTML = cardsHtml; 
      // (Note: This removes the hidden 'loadingMsg' and 'noResults' from DOM, which is fine because if we need them back we'd likely reload the page or re-inject them).
      
      grid.appendChild(noResults); // Append noResults back just in case they filter to 0 later
      
      loadMoreBtn.style.display = displayedRecipes < recipesToShow.length ? 'inline-block' : 'none';
      window.currentFilteredRecipes = recipesToShow;
    }

    // Expose functions globally for buttons
    window.loadMoreRecipes = function() {
      const recipesToShow = window.currentFilteredRecipes || recipes;
      displayedRecipes += RECIPES_PER_PAGE;
      displayRecipes(recipesToShow);
    };

    // EVENT LISTENERS
    document.getElementById('searchBtn').addEventListener('click', applyFiltersAndDisplay);
    
    document.getElementById('recipeSearch').addEventListener('keypress', (e) => {
        if(e.key === 'Enter') applyFiltersAndDisplay();
    });

    document.getElementById('clearBtn').addEventListener('click', () => {
        document.getElementById('recipeSearch').value = '';
        document.getElementById('categoryFilter').value = 'all';
        document.getElementById('dishTypeFilter').value = 'all';
        document.getElementById('sortBy').value = 'alphabetical';
        applyFiltersAndDisplay();
    });

    // Start
    setupRecipeListener();
  </script>

</body>
</html>
